<div class="calc-box" id="netCalc">
    <h2>מחשבון רווחים נטו</h2>
    <small dir="ltr"><small><small>Version 0.004 UI</small></small></small>

    <!-- פרטי עסקה -->
    <div class="calc-section">
        <div class="calc-section-title">פרטי עסקה</div>

        <div class="calc-row">
            <label for="net_buyPrice">מחיר קנייה ($):</label>
            <input id="net_buyPrice" type="number" min="0" step="0.01" dir="ltr" />
        </div>

        <div class="calc-row">
            <label for="net_sellPrice">מחיר מכירה ($):</label>
            <input id="net_sellPrice" type="number" min="0" step="0.01" dir="ltr" />
        </div>

        <div class="calc-row">
            <label for="net_qty">כמות (מניות):</label>
            <input id="net_qty" type="number" min="1" step="1" value="1" dir="ltr" />
        </div>
    </div>

    <!-- עמלות ומסים -->
    <div class="calc-section">
        <div class="calc-section-title">עמלות ומסים</div>

        <div class="calc-row">
            <label for="net_feeProfile">פרופיל עמלות:</label>
            <div class="input-with-button">
                <select id="net_feeProfile">
                    <option value="">טוען פרופילים...</option>
                </select>
                <button id="net_btnAddFeeProfile" type="button" class="calc-btn-secondary">
                    ➕ פרופיל עמלות
                </button>
            </div>
        </div>

        <div class="calc-row">
            <label for="net_taxProfile">פרופיל מס:</label>
            <div class="input-with-button">
                <select id="net_taxProfile">
                    <option value="">טוען פרופילים...</option>
                </select>
                <button id="net_btnAddTaxProfile" type="button" class="calc-btn-secondary">
                    ➕ פרופיל מס
                </button>
            </div>
        </div>

        <!-- יצירת פרופיל עמלות חדש (localStorage) -->
        <div class="accordion" style="margin-top:12px;">
            <input type="checkbox" id="net_fee_new_toggle">
            <label for="net_fee_new_toggle" class="accordion-label">
                יצירת פרופיל עמלות חדש (שמירה מקומית)
            </label>

            <div class="accordion-content">
                <div class="calc-row">
                    <label for="net_newFee_name">שם פרופיל (חייב להיות ייחודי במכשיר):</label>
                    <input id="net_newFee_name" type="text" placeholder="לדוגמה: בנק הפועלים 60%" />
                </div>

                <div class="calc-row">
                    <label for="net_newFee_execBuy">עמלת ביצוע קנייה ($) (חד-פעמית):</label>
                    <input id="net_newFee_execBuy" type="number" min="0" step="0.01" dir="ltr" />
                </div>

                <div class="calc-row">
                    <label for="net_newFee_execSell">עמלת ביצוע מכירה ($) (חד-פעמית):</label>
                    <input id="net_newFee_execSell" type="number" min="0" step="0.01" dir="ltr" />
                </div>

                <div class="calc-row">
                    <label for="net_newFee_brokerPerShare">עמלת ברוקר ($) לכל מניה:</label>
                    <input id="net_newFee_brokerPerShare" type="number" min="0" step="0.0001" dir="ltr" />
                </div>

                <div class="calc-row">
                    <label for="net_newFee_discountPct">הנחת לקוח (%) על סך העמלות:</label>
                    <input id="net_newFee_discountPct" type="number" min="0" max="100" step="0.1" dir="ltr" />
                </div>

                <button id="net_btnSaveFeeProfile" type="button" class="calc-btn">
                    שמור פרופיל עמלות במכשיר
                </button>

                <div id="net_feeProfileMsg" class="help-box" style="display:none;"></div>
            </div>
        </div>

        <!-- יצירת פרופיל מס חדש (localStorage) -->
        <div class="accordion" style="margin-top:12px;">
            <input type="checkbox" id="net_tax_new_toggle">
            <label for="net_tax_new_toggle" class="accordion-label">
                יצירת פרופיל מס חדש (שמירה מקומית)
            </label>

            <div class="accordion-content">
                <div class="calc-row">
                    <label for="net_newTax_name">שם פרופיל:</label>
                    <input id="net_newTax_name" type="text" placeholder="לדוגמה: רווח הון 25%" />
                </div>

                <div class="calc-row">
                    <label for="net_newTax_pct">אחוז מס (%):</label>
                    <input id="net_newTax_pct" type="number" min="0" max="100" step="0.1" dir="ltr" />
                </div>

                <button id="net_btnSaveTaxProfile" type="button" class="calc-btn">
                    שמור פרופיל מס במכשיר
                </button>

                <div id="net_taxProfileMsg" class="help-box" style="display:none;"></div>
            </div>
        </div>
    </div>

    <button id="net_btnCalc" type="button" class="calc-btn">
        חשב רווח נטו
    </button>

    <!-- תוצאות -->
    <div class="calc-results" id="netResults" style="display:none;">
        <div class="result-row">
            <div class="result-label">השקעה (עלות קנייה)</div>
            <div class="result-value">
                <span class="value-ltr">$<span id="net_totalBuy">0.00</span></span>
            </div>
        </div>

        <div class="result-row">
            <div class="result-label">תמורה (מכירה)</div>
            <div class="result-value">
                <span class="value-ltr">$<span id="net_totalSell">0.00</span></span>
            </div>
        </div>

        <div class="result-separator"></div>

        <div class="result-row">
            <div class="result-label">רווח ברוטו</div>
            <div class="result-value">
                <span class="value-ltr">$<span id="net_grossProfit">0.00</span></span>
                <span class="value-sub-ltr">(<span id="net_grossPct">0.00</span>%)</span>
            </div>
        </div>

        <div class="result-row">
            <div class="result-label">עמלות (אחרי הנחה)</div>
            <div class="result-value">
                <span class="value-ltr">$<span id="net_totalFees">0.00</span></span>
            </div>
        </div>

        <div class="result-row">
            <div class="result-label">מס</div>
            <div class="result-value">
                <span class="value-ltr">$<span id="net_tax">0.00</span></span>
            </div>
        </div>

        <div class="result-separator"></div>

        <div class="result-row">
            <div class="result-label"><strong>רווח נטו</strong></div>
            <div class="result-value">
                <strong class="value-ltr">$<span id="net_netProfit">0.00</span></strong>
                <span class="value-sub-ltr">(<span id="net_netPct">0.00</span>%)</span>
            </div>
        </div>

        <div class="accordion" style="margin-top:10px;">
            <input type="checkbox" id="net_help_toggle">
            <label for="net_help_toggle" class="accordion-label">
                איך זה מחושב?
            </label>
            <div class="accordion-content">
                <p>
                    * רווח ברוטו = (מכירה - קנייה) × כמות<br>
                    * עמלות = (עמלת ביצוע קנייה + עמלת ביצוע מכירה + עמלת ברוקר×כמות) פחות הנחה<br>
                    * מס = אחוז מס × max(רווח ברוטו - עמלות, 0)<br>
                    * רווח נטו = רווח ברוטו - עמלות - מס
                </p>
            </div>
        </div>
    </div>
</div>
<script>
    (function () {
        "use strict";

        const FEES_URL = "https://oferhaviv.github.io/Oferhaviv.blogspot/db/fee_profiles.json";
        const TAX_URL = "https://oferhaviv.github.io/Oferhaviv.blogspot/db/tax_profiles.json";

        const LS_FEES_KEY = "net_fee_profiles_local";
        const LS_TAX_KEY = "net_tax_profiles_local";

        function $(id) { return document.getElementById(id); }

        function setSelectStatus(selectEl, text) {
            if (!selectEl) return;
            selectEl.innerHTML = "";
            const opt = document.createElement("option");
            opt.value = "";
            opt.textContent = text;
            selectEl.appendChild(opt);
        }

        async function fetchJson(url) {
            const res = await fetch(url, { cache: "no-store" });
            if (!res.ok) throw new Error("HTTP " + res.status + " for " + url);
            return await res.json();
        }

        function readLocalProfiles(key) {
            try {
                const raw = localStorage.getItem(key);
                if (!raw) return [];
                const parsed = JSON.parse(raw);
                return Array.isArray(parsed) ? parsed : [];
            } catch (e) {
                return [];
            }
        }

        function mergeByName(serverArr, localArr) {
            const out = [];
            const seen = new Set();

            (serverArr || []).forEach(p => {
                const name = (p && p.name) ? String(p.name).trim() : "";
                if (!name || seen.has(name.toLowerCase())) return;
                seen.add(name.toLowerCase());
                out.push(p);
            });

            (localArr || []).forEach(p => {
                const name = (p && p.name) ? String(p.name).trim() : "";
                if (!name || seen.has(name.toLowerCase())) return;
                seen.add(name.toLowerCase());
                out.push(p);
            });

            return out;
        }

        function populateSelect(selectEl, profiles) {
            if (!selectEl) return;

            selectEl.innerHTML = "";

            const first = document.createElement("option");
            first.value = "";
            first.textContent = "בחר...";
            selectEl.appendChild(first);

            profiles.forEach(p => {
                const opt = document.createElement("option");
                opt.value = p.id || p.name;
                opt.textContent = p.name;
                selectEl.appendChild(opt);
            });

            if (profiles.length > 0) selectEl.value = (profiles[0].id || profiles[0].name);
        }

        // נשמור בזיכרון לשלב החישוב
        let feeProfiles = [];
        let taxProfiles = [];

        async function initNetProfiles() {
            const feeSelect = $("net_feeProfile");
            const taxSelect = $("net_taxProfile");

            setSelectStatus(feeSelect, "טוען פרופילי עמלות...");
            setSelectStatus(taxSelect, "טוען פרופילי מס...");

            try {
                const [feesDb, taxDb] = await Promise.all([
                    fetchJson(FEES_URL),
                    fetchJson(TAX_URL)
                ]);

                const serverFees = (feesDb && feesDb.profiles) ? feesDb.profiles : [];
                const serverTaxes = (taxDb && taxDb.profiles) ? taxDb.profiles : [];

                const localFees = readLocalProfiles(LS_FEES_KEY);
                const localTaxes = readLocalProfiles(LS_TAX_KEY);

                feeProfiles = mergeByName(serverFees, localFees);
                taxProfiles = mergeByName(serverTaxes, localTaxes);

                populateSelect(feeSelect, feeProfiles);
                populateSelect(taxSelect, taxProfiles);

                // Debug
                window.__net_feeProfiles = feeProfiles;
                window.__net_taxProfiles = taxProfiles;
                console.log("Loaded fee profiles:", feeProfiles);
                console.log("Loaded tax profiles:", taxProfiles);

            } catch (e) {
                console.error(e);
                setSelectStatus(feeSelect, "שגיאה בטעינת פרופילי עמלות");
                setSelectStatus(taxSelect, "שגיאה בטעינת פרופילי מס");
            }
        }

        function onReady(fn) {
            if (document.readyState === "loading") {
                document.addEventListener("DOMContentLoaded", fn);
            } else {
                fn();
            }
        }

        // Retry קצר – בבְּלוֹגֶר לפעמים האלמנטים “מופיעים” טיפה אחרי הסקריפט
        onReady(function () {
            let tries = 0;
            (function tryInit() {
                tries++;
                if ($("net_feeProfile") && $("net_taxProfile")) {
                    initNetProfiles();
                    return;
                }
                if (tries < 20) return setTimeout(tryInit, 100);
                console.warn("net selects not found (net_feeProfile / net_taxProfile).");
            })();
        });

    })();
</script>
